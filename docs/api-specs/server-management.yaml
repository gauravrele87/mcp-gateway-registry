openapi: 3.0.0
info:
  title: Server Management API
  description: Internal and UI endpoints for MCP server management, registration, and administration
  version: 1.0.0
  contact:
    name: MCP Gateway Registry
  license:
    name: MIT

servers:
  - url: http://localhost:7860
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: UI Server Management
    description: Dashboard and UI endpoints (Session Cookie auth)
  - name: Admin Operations
    description: Administrative endpoints (HTTP Basic auth)
  - name: Token Management
    description: JWT token generation and management
  - name: Group Management
    description: User group and permission management

paths:
  /api/:
    get:
      tags:
        - UI Server Management
      summary: Dashboard home
      description: Main dashboard showing services based on user permissions
      operationId: getDashboard
      security:
        - SessionCookie: []
      parameters:
        - name: query
          in: query
          schema:
            type: string
          description: Search query for services
      responses:
        '200':
          description: HTML dashboard page
          content:
            text/html:
              schema:
                type: string

  /api/servers:
    get:
      tags:
        - UI Server Management
      summary: Get servers as JSON
      description: Get servers data as JSON for React frontend
      operationId: getServersJson
      security:
        - SessionCookie: []
      parameters:
        - name: query
          in: query
          schema:
            type: string
          description: Search query
      responses:
        '200':
          description: List of servers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerListResponse'

  /api/server_details/{service_path}:
    get:
      tags:
        - UI Server Management
      summary: Get server details
      description: Get detailed information about a server by path or all servers
      operationId: getServerDetails
      security:
        - SessionCookie: []
      parameters:
        - name: service_path
          in: path
          required: true
          schema:
            type: string
          description: Service path or 'all'
      responses:
        '200':
          description: Server details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerDetail'

  /api/tools/{service_path}:
    get:
      tags:
        - UI Server Management
      summary: Get service tools
      description: Get list of tools provided by a service
      operationId: getServiceTools
      security:
        - SessionCookie: []
      parameters:
        - name: service_path
          in: path
          required: true
          schema:
            type: string
          description: Service path or 'all'
      responses:
        '200':
          description: List of tools
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToolsResponse'
        '404':
          description: Service not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Service disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: User lacks access
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/register:
    post:
      tags:
        - UI Server Management
      summary: Register new service
      description: Register a new service via dashboard
      operationId: registerService
      security:
        - SessionCookie: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/ServiceRegistration'
      responses:
        '201':
          description: Service registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceResponse'
        '400':
          description: Service already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: User lacks register permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/edit/{service_path}:
    get:
      tags:
        - UI Server Management
      summary: Get edit form
      description: Show edit form for service
      operationId: getEditForm
      security:
        - SessionCookie: []
      parameters:
        - name: service_path
          in: path
          required: true
          schema:
            type: string
          description: Service path
      responses:
        '200':
          description: HTML edit form
          content:
            text/html:
              schema:
                type: string

    post:
      tags:
        - UI Server Management
      summary: Update service
      description: Handle service edit submission
      operationId: updateService
      security:
        - SessionCookie: []
      parameters:
        - name: service_path
          in: path
          required: true
          schema:
            type: string
          description: Service path
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/ServiceRegistration'
      responses:
        '303':
          description: Redirect to home
        '403':
          description: User lacks modify permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/toggle/{service_path}:
    post:
      tags:
        - UI Server Management
      summary: Toggle service status
      description: Enable or disable a service
      operationId: toggleService
      security:
        - SessionCookie: []
      parameters:
        - name: service_path
          in: path
          required: true
          schema:
            type: string
          description: Service path
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                enabled:
                  type: boolean
      responses:
        '200':
          description: Service toggled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToggleResponse'
        '404':
          description: Service not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: User lacks toggle permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/refresh/{service_path}:
    post:
      tags:
        - UI Server Management
      summary: Refresh service health
      description: Refresh service health and tools information
      operationId: refreshService
      security:
        - SessionCookie: []
      parameters:
        - name: service_path
          in: path
          required: true
          schema:
            type: string
          description: Service path
      responses:
        '200':
          description: Service refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshResponse'

  /api/tokens:
    get:
      tags:
        - Token Management
      summary: Token generation page
      description: Show JWT token generation form
      operationId: getTokenPage
      security:
        - SessionCookie: []
      responses:
        '200':
          description: HTML token generation form
          content:
            text/html:
              schema:
                type: string

  /api/tokens/generate:
    post:
      tags:
        - Token Management
      summary: Generate JWT token
      description: Generate JWT token for authenticated user
      operationId: generateToken
      security:
        - SessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TokenGenerationRequest'
      responses:
        '200':
          description: Token generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'

  /api/internal/register:
    post:
      tags:
        - Admin Operations
      summary: Internal service registration
      description: Register service for mcpgw-server (auto-enables service)
      operationId: internalRegisterService
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/InternalServiceRegistration'
      responses:
        '201':
          description: Service registered successfully
        '409':
          description: Service already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/internal/remove:
    post:
      tags:
        - Admin Operations
      summary: Remove service
      description: Remove a service from registry
      operationId: internalRemoveService
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - service_path
              properties:
                service_path:
                  type: string
      responses:
        '200':
          description: Service removed successfully
        '404':
          description: Service not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/internal/toggle:
    post:
      tags:
        - Admin Operations
      summary: Internal toggle service
      description: Enable or disable service
      operationId: internalToggleService
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - service_path
              properties:
                service_path:
                  type: string
      responses:
        '200':
          description: Service toggled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToggleResponse'

  /api/internal/healthcheck:
    post:
      tags:
        - Admin Operations
      summary: Health check all services
      description: Get health status for all servers
      operationId: internalHealthcheck
      security:
        - BasicAuth: []
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'

  /api/internal/list:
    get:
      tags:
        - Admin Operations
      summary: List all services
      description: Get list of all services with health status
      operationId: internalListServices
      security:
        - BasicAuth: []
      responses:
        '200':
          description: List of services
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerListResponse'

  /api/internal/add-to-groups:
    post:
      tags:
        - Group Management
      summary: Add server to groups
      description: Add a server to user groups
      operationId: addServerToGroups
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - server_name
                - group_names
              properties:
                server_name:
                  type: string
                group_names:
                  type: string
                  description: Comma-separated group names
      responses:
        '200':
          description: Server added to groups
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/internal/remove-from-groups:
    post:
      tags:
        - Group Management
      summary: Remove server from groups
      description: Remove a server from user groups
      operationId: removeServerFromGroups
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - server_name
                - group_names
              properties:
                server_name:
                  type: string
                group_names:
                  type: string
                  description: Comma-separated group names
      responses:
        '200':
          description: Server removed from groups

  /api/internal/create-group:
    post:
      tags:
        - Group Management
      summary: Create group
      description: Create a new user group
      operationId: createGroup
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - group_name
              properties:
                group_name:
                  type: string
                description:
                  type: string
                create_in_keycloak:
                  type: boolean
      responses:
        '200':
          description: Group created

  /api/internal/delete-group:
    post:
      tags:
        - Group Management
      summary: Delete group
      description: Delete a user group (prevents deletion of system groups)
      operationId: deleteGroup
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - group_name
              properties:
                group_name:
                  type: string
                delete_from_keycloak:
                  type: boolean
                force:
                  type: boolean
      responses:
        '200':
          description: Group deleted

  /api/internal/list-groups:
    get:
      tags:
        - Group Management
      summary: List groups
      description: List all user groups with optional Keycloak and scopes information
      operationId: listGroups
      security:
        - BasicAuth: []
      parameters:
        - name: include_keycloak
          in: query
          schema:
            type: boolean
            default: true
        - name: include_scopes
          in: query
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: List of groups
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupListResponse'

  /api/admin/tokens:
    get:
      tags:
        - Token Management
      summary: Admin get Keycloak token
      description: Admin-only endpoint to retrieve M2M tokens
      operationId: adminGetTokens
      security:
        - BasicAuth: []
      responses:
        '200':
          description: Access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '403':
          description: Non-admin user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    SessionCookie:
      type: apiKey
      in: cookie
      name: mcp_gateway_session
    BasicAuth:
      type: http
      scheme: basic
      description: Admin credentials (ADMIN_USER:ADMIN_PASSWORD)

  schemas:
    ServerListResponse:
      type: object
      properties:
        servers:
          type: array
          items:
            $ref: '#/components/schemas/Server'

    Server:
      type: object
      properties:
        path:
          type: string
        name:
          type: string
        description:
          type: string
        is_enabled:
          type: boolean
        health_status:
          type: string
          enum: [healthy, unhealthy, unknown]

    ServerDetail:
      type: object
      properties:
        path:
          type: string
        name:
          type: string
        description:
          type: string
        url:
          type: string
        is_enabled:
          type: boolean
        num_tools:
          type: integer
        health_status:
          type: string
        last_health_check:
          type: string
          format: date-time

    ToolsResponse:
      type: object
      properties:
        tools:
          type: array
          items:
            $ref: '#/components/schemas/Tool'

    Tool:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        inputSchema:
          type: object

    ServiceRegistration:
      type: object
      required:
        - name
        - description
        - path
        - proxy_pass_url
      properties:
        name:
          type: string
        description:
          type: string
        path:
          type: string
        proxy_pass_url:
          type: string
        tags:
          type: string
        num_tools:
          type: integer
        num_stars:
          type: integer
        is_python:
          type: boolean
        license:
          type: string

    InternalServiceRegistration:
      type: object
      required:
        - service_path
      properties:
        service_path:
          type: string
        name:
          type: string
        description:
          type: string
        proxy_pass_url:
          type: string
        auth_provider:
          type: string
        auth_type:
          type: string
        supported_transports:
          type: array
          items:
            type: string
        headers:
          type: object
        tool_list_json:
          type: string
        overwrite:
          type: boolean

    ServiceResponse:
      type: object
      properties:
        path:
          type: string
        name:
          type: string
        message:
          type: string

    ToggleResponse:
      type: object
      properties:
        path:
          type: string
        is_enabled:
          type: boolean
        message:
          type: string

    RefreshResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string

    TokenGenerationRequest:
      type: object
      properties:
        requested_scopes:
          type: array
          items:
            type: string
        expires_in_hours:
          type: integer
          default: 8
        description:
          type: string

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
        token_type:
          type: string
          default: Bearer
        expires_in:
          type: integer
          description: Seconds until expiration
        refresh_token:
          type: string
        scope:
          type: string
          description: Space-separated scopes

    HealthCheckResponse:
      type: object
      properties:
        status:
          type: string
        services:
          type: object
          additionalProperties:
            type: object

    GroupListResponse:
      type: object
      properties:
        groups:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              description:
                type: string
              servers:
                type: array
                items:
                  type: string

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
        error_code:
          type: string
        request_id:
          type: string
